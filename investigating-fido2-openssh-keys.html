<!DOCTYPE html><html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><!--replace-start-0--><!--replace-start-5--><!--replace-start-8--><title>Spike: Investigating new Fido2-backed OpenSSH keys - My Zettelkasten</title><!--replace-end-8--><!--replace-end-5--><!--replace-end-0--><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Merriweather|Libre+Franklin|Roboto+Mono&amp;display=swap" rel="stylesheet" /><!--replace-start-1--><!--replace-start-4--><!--replace-start-7--><link href="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" rel="icon" /><meta content="I would like to secure ssh access to some servers with a second factor." name="description" /><meta content="Spike: Investigating new Fido2-backed OpenSSH keys" property="og:title" /><meta content="My Zettelkasten" property="og:site_name" /><meta content="article" property="og:type" /><meta content="14f22722" property="neuron:zettel-id" /><meta content="investigating-fido2-openssh-keys" property="neuron:zettel-slug" /><meta content="spike" property="neuron:zettel-tag" /><script type="application/ld+json">[]</script><style type="text/css">body{background-color:#eeeeee !important;font-family:"Libre Franklin", serif !important}body .ui.container{font-family:"Libre Franklin", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"Merriweather", sans-serif !important}body code, pre, tt, .monoFont{font-family:"Roboto Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index p.info{color:#808080}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body .zettel-content h1#title-h1{background-color:rgba(33,133,208,0.1)}body nav.bottomPane{background-color:rgba(33,133,208,2.0e-2)}body div#footnotes{border-top-color:#2185d0}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.94999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) a{color:#808080 !important}body div.container.universe{padding-top:1em}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .pandoc .highlight{background-color:#ffff00}body div.zettel-view .pandoc .ui.disabled.fitted.checkbox{margin-right:0.29999em;vertical-align:middle}body div.zettel-view .zettel-content .metadata{margin-top:1em}body div.zettel-view .zettel-content .metadata div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content div#footnotes ol > li > p:only-of-type{display:inline;margin-right:0.5em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f5f2f0}body div.zettel-view .zettel-content pre{overflow:auto}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .ui.label.zettel-tag{color:#000000}body .ui.label.zettel-tag a{color:#000000}body nav.bottomPane ul.backlinks > li{padding-bottom:0.4em;list-style-type:disc}body nav.bottomPane ul.context-list > li{list-style-type:lower-roman}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}body span.zettel-link-container span.zettel-link a{color:#2185d0;font-weight:bold;text-decoration:none}body span.zettel-link-container span.zettel-link a:hover{background-color:rgba(33,133,208,0.1)}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.errors{border:solid 1px #ff0000}body span.zettel-link-container.errors span.zettel-link a:hover{text-decoration:none !important;cursor:not-allowed}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}</style><script async="" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" rel="stylesheet" /><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js"></script><!--replace-end-7--><!--replace-end-4--><!--replace-end-1--></head><body><div class="ui fluid container universe"><!--replace-start-2--><!--replace-start-3--><!--replace-start-6--><div class="ui text container" id="zettel-container" style="position: relative"><div class="zettel-view"><article class="ui raised attached segment zettel-content"><div class="pandoc"><h1 id="title-h1">Spike: Investigating new Fido2-backed OpenSSH keys</h1><p>I would like to secure ssh access to some servers with a second factor.</p><p><strong>Criteria</strong></p><ul><li>It shouldn’t be <em>too</em> easy to misconfigure, especially when it comes to accidentally locking myself out or being insecure</li><li>It should be minimal effort during usage</li><li>The key material should be generated on a hardware token without possibility of retrieval</li><li>Rolling out keys to multiple servers and rotating keys should be automatable using Ansible</li></ul><p><strong>Secondary and Non-Goals</strong></p><ul><li>It doesn’t have to be free or necessarily the cheapest hardware token available.</li><li>I don’t need a retrieval option, I’m assuming that if I lose the key I can access the server in another way to deploy a new one.</li></ul><h2 id="tldr">tl;dr</h2><ul><li>It’s relatively new but most distros’ LTS versions are supported.</li><li>If you don’t trust NIST curves, you need to have a recent yubikey (Firmware &gt;= 5.2.3, according to <a href="https://www.yubico.com/blog/whats-new-in-yubikey-firmware-5-2-3/" title="cf">this announcement</a> you should be fine if you bought it no earlier than 2020)</li></ul><h2 id="scope">Scope</h2><p>Completely ignoring the hardware second factor aspect, ssh keys fit the bill. I recently noticed that there’s two new types of keys: ecdsa-sk and ed25519-sk. According to <a href="https://security.stackexchange.com/questions/240991/what-is-the-sk-ending-for-ssh-key-types" title="cf">this Stackoverflow post</a>, they work like regular keys except they also require a Yubikey to use.</p><p>I’ve been using my Yubikey 5c for a while and like it, so this sounds intriguing.</p><h2 id="log">Log</h2><p>If you’re not interested in the details or my process, skip this section.</p><p>I have my Yubikey plugged in and try to create a key using <code>ssh-keygen -t ed25519-sk -f testkey</code>. It fails with this error:</p><pre><code class="language-none">&gt; ssh-keygen -t ed25519-sk -f testkey
Generating public/private ed25519-sk key pair.
You may need to touch your authenticator to authorize key generation.
/usr/lib/ssh/ssh-sk-helper: error while loading shared libraries: libfido2.so.1: cannot open shared object file: No such file or directory
ssh_msg_recv: read header: Connection reset by peer
client_converse: receive: unexpected internal error
reap_helper: helper exited with non-zero exit status
Key enrollment failed: unexpected internal error</code></pre><p>Arch Linux apparently doesn’t automatically install libfido2. After running <code>sudo pacman -Sy libfido2</code>, it fails in another way. (At this point, I also discovered a <a href="https://bugs.archlinux.org/task/65513" title="cf">recent Arch Linux issue about this</a>, but luckily it seems to have already been fixed.)</p><pre><code class="language-none">&gt; ssh-keygen -t ed25519-sk -f testkey
Generating public/private ed25519-sk key pair.
You may need to touch your authenticator to authorize key generation.
Key enrollment failed: invalid format`</code></pre><p>The reporter of the Arch Linux issue linked above also mentioned <code>community/libu2f-host</code> and <code>community/libu2f-server</code>, so I tried to install them too, but there doesn’t seem to be a libu2f-host package. Installing <code>libu2f-host</code> didn’t change anything.</p><p>After reading <a href="https://lwn.net/Articles/812537/" title="cf">the lwn post from the Arch Linux issue</a> a bit, I know more about how it should work but still nothing about why it doesn’t.</p><p>So I tried it with <code>ssh-keygen -t ecdsa-sk -f testkey</code>, which works. It makes me touch the key and asks for a passphrase. I would prefer ed25519 though, so I’m looking into it a bit more.</p><p>I found <a href="https://github.com/Yubico/libfido2/issues/125" title="cf">this github issue</a>, which looks like my error at first. But my verbose stderr is different:</p><pre><code class="language-none">&gt; ssh-keygen -vvvv -t ed25519-sk -f testkey
Generating public/private ed25519-sk key pair.
You may need to touch your authenticator to authorize key generation.
debug3: start_helper: started pid=144578
debug3: ssh_msg_send: type 5
debug3: ssh_msg_recv entering
debug1: start_helper: starting /usr/lib/ssh/ssh-sk-helper
debug1: sshsk_enroll: provider &quot;internal&quot;, device &quot;(null)&quot;, application &quot;ssh:&quot;, userid &quot;(null)&quot;, flags 0x01, challenge len 0
debug1: sshsk_enroll: using random challenge
debug1: sk_probe: 1 device(s) detected
debug1: sk_probe: selecting sk by touch
debug1: ssh_sk_enroll: using device /dev/hidraw14
debug1: ssh_sk_enroll: fido_dev_make_cred: FIDO_ERR_INVALID_ARGUMENT
debug1: sshsk_enroll: provider &quot;internal&quot; failure -1
debug1: ssh-sk-helper: Enrollment failed: invalid format
debug1: main: reply len 8
debug3: ssh_msg_send: type 5
debug1: client_converse: helper returned error -4
debug3: reap_helper: pid=144578
Key enrollment failed: invalid format</code></pre><p>I ran a few commands that were suggested to debug, and some seemed weird, but another thought came to my mind: Does my Yubikey support ed25519-sk? According to <a href="https://cryptsus.com/blog/how-to-configure-openssh-with-yubikey-security-keys-u2f-otp-authentication-ed25519-sk-ecdsa-sk-on-ubuntu-18.04.html" title="cf">this guide</a>, it needs firmware version 5.2.3. I installed <code>ykman</code> (package <code>yubikey-manager</code> on Arch) and ran <code>ykman info</code>:</p><pre><code class="language-none">&gt; ykman info                                                                                                                                                                                              ~
WARNING: PC/SC not available. Smart card protocols will not function.
Device type: YubiKey 5C
Serial number: 10348433
Firmware version: 5.1.2
Form factor: Keychain (USB-C)
Enabled USB interfaces: FIDO, CCID

Applications
FIDO2           Disabled
OTP             Disabled
FIDO U2F        Enabled
OATH            Enabled
YubiHSM Auth    Not available
OpenPGP         Enabled
PIV             Enabled</code></pre><p>Meh. Let’s shelve this and focus on the spike, I’ll see if I can update the firmware later.</p><p>I copied the ecdsa-key I generated earlier to a server of mine and tried to log in, but it’s still asking me for a password. My suspicion is that the host also needs to support the -sk keys. <code>ssh -V</code> on the server reports <code>OpenSSH_7.9p1</code>, while I have <code>OpenSSH_8.9p1</code> locally. According to <a href="https://www.openssh.com/txt/release-8.2" title="cf">the openssh 8.2 release notes</a>, the feature was released in that version.</p><p>That server is running debian 10, which isn’t the current one, but this still makes me think whether I can get a recent-enough OpenSSH version on all relevant servers.</p><p>I have another server running OpenSSH_8.8p1, so I added the public key there.</p><p>For that machine, it works great:</p><pre><code class="language-none">&gt; ssh -o IdentitiesOnly=yes -o IdentityFile=testkey myserver
Enter passphrase for key &#39;testkey&#39;:
Confirm user presence for key ECDSA-SK SHA256:8Z+EQ594E5FfqlZP/EaqhloBZZuEI2d64RjpkPcHYVk
User presence confirmed
 ________________
&lt; sick motd bruh &gt;
 ----------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||</code></pre><p>I think these results give me enough information for now.</p><h2 id="question-and-sidetracks">Question and sidetracks</h2><ol><li><p>Is there actually essential key material generated on the Yubikey that never leaves it? How does it work?</p><ul><li><p>Looks good. Quoting <a href="https://lwn.net/Articles/812537/" title="cf">https://lwn.net/Articles/812537/</a></p><pre><code class="language-none">FIDO/U2F OpenSSH keys consist of two parts: a &quot;key handle&quot; part stored
in the private key file on disk, and a per-device private key that is
unique to each FIDO/U2F token and that cannot be exported from the
token hardware. These are combined by the hardware at authentication
time to derive the real key that is used to sign authentication
challenges.</code></pre></li></ul></li><li><p>There seems to be a way to store everything on the Yubikey so that there’s no need to keep a key file around. Keyword is “resident keys”, but I don’t need that at the moment, so I’m not looking into it right now.</p></li><li><p>My firmware version only supports ecdsa-sk, not ed25519-sk. Can I upgrade it?</p><ul><li><a href="https://support.yubico.com/hc/en-us/articles/360013708760-YubiKey-Firmware-Is-Not-Upgradeable" title="cf">Yubikey firmware is not upgradeable</a> :|</li></ul></li><li><p>Can I install a recent-enough OpenSSH version on all relevant servers?</p><ul><li>Current Debian ships OpenSSH 8.4, Ubuntu 20.04 LTS ships 8.2, both of which should be fine. Centos 7 ships OpenSSH 7.4, which I assume won’t work. Alpine 3.15 ships 8.4.</li></ul></li></ol><h2 id="reflection">Reflection</h2><ul><li>Generally, it seems to work great, even though I’d prefer ed25519.</li><li>OpenSSH server version requirements are concerning.</li><li>Yubikey 5c is not the cheapest, but it might be preferable for developers because of features besides Fido.</li></ul><p>Looking at the criteria defined before the spike:</p><ul><li><p>It shouldn’t be <em>too</em> easy to misconfigure, especially when it comes to accidentally locking myself out or being insecure Using ssh keys for this is cool, I know pretty well how to deal with them.</p></li><li><p>It should be minimal effort during usage Literally just touching the button. There’s even some potential to make it even more convenient (resident keys, ssh-add -K, no-touch-required)</p></li><li><p>The key material should be generated on a hardware token without possibility of retrieval Confirmed with information from LWN and the OpenSSH 8.2 release notes.</p></li><li><p>Rolling out keys to multiple servers and rotating keys should be automatable using Ansible Trivial with ssh keys</p></li><li><p>It doesn’t have to be free or necessarily the cheapest hardware token available.</p></li></ul><p>Yubikey 5c is reasonably priced in my opinion. There might also be cheaper options, possibly with less features. The cheaper [[<a href="https://www.yubico.com/de/product/security-key-nfc-by-yubico/">https://www.yubico.com/de/product/security-key-nfc-by-yubico/</a>|Yubico Security Key NFC]] also supports Fido2 and comes at 25€.</p></div><div class="metadata"><div class="date" title="Zettel date"><time datetime="2022-03-12T01:19">2022-03-12</time></div></div></article><nav class="ui attached segment deemphasized backlinksPane" id="neuron-backlinks-pane"><h3 class="ui header">Backlinks</h3><ul class="backlinks"><li><span class="zettel-link-container cf"><span class="zettel-link" title="2021-05-28T03:11"><a href=".">voyd’s lab notes</a></span></span><ul class="context-list" style="zoom: 85%;"></ul></li></ul></nav><nav class="ui attached segment deemphasized bottomPane" id="neuron-tags-pane"><div><span class="ui basic label zettel-tag" title="Tag">spike</span></div></nav><nav class="ui bottom attached icon compact inverted menu blue" id="neuron-nav-bar"><!--replace-start-9--><a class="item" href="." title="Home"><i class="home icon"></i></a><!--replace-end-9--><a class="right item" href="impulse" title="Open Impulse"><i class="wave square icon"></i></a></nav></div></div><!--replace-end-6--><!--replace-end-3--><!--replace-end-2--><div class="ui center aligned container footer-version"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron 1.9.35.0" /></a></div></div></div></body></html>